{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Detalhes do ETP - {{ etp.titulo }}{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-5 fw-bold text-primary mb-0">Detalhes do ETP</h1>
            <p class="lead">{{ etp.titulo }}</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'contratacoes:editar_etp' pk=etp.pk %}" class="btn btn-warning">
                <i class="fas fa-edit me-2"></i>Editar ETP
            </a>
            <a href="{% url 'contratacoes:gerar_etp_pdf' pk=etp.pk %}" class="btn btn-info">
                <i class="fas fa-file-pdf me-2"></i>Gerar PDF
            </a>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">Status e Ações do Workflow</h5>
        </div>
        <div class="card-body">
            <p>Status Atual: <span class="badge bg-primary fs-6 rounded-pill">{{ etp.get_status_display }}</span></p>
            
            <form method="post" action="{% url 'contratacoes:processar_acao_etp' pk=etp.pk %}" class="d-inline">
                {% csrf_token %}

                {% if etp.status == 'EM_ELABORACAO' and perms.contratacoes.pode_submeter_etp_analise %}
                    <button type="submit" name="acao" value="submeter_analise" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Enviar para Análise
                    </button>
                {% endif %}

                {% if etp.status == 'AGUARDANDO_ANALISE' %}
                    {% if perms.contratacoes.pode_aprovar_etp_analise %}
                        <button type="submit" name="acao" value="aprovar_analise" class="btn btn-success">
                            <i class="fas fa-check me-2"></i>Aprovar (Análise)
                        </button>
                    {% endif %}
                    {% if perms.contratacoes.pode_recusar_etp_analise %}
                        <button type="submit" name="acao" value="recusar_analise" class="btn btn-danger">
                            <i class="fas fa-times me-2"></i>Recusar (Análise)
                        </button>
                    {% endif %}
                {% endif %}
                
                {% if etp.status == 'AGUARDANDO_ORCAMENTO' %}
                     {% if perms.contratacoes.pode_aprovar_etp_orcamento %}
                        <button type="submit" name="acao" value="aprovar_orcamento" class="btn btn-success">
                            <i class="fas fa-check-double me-2"></i>Aprovar (Orçamento)
                        </button>
                    {% endif %}
                     {% if perms.contratacoes.pode_recusar_etp_orcamento %}
                        <button type="submit" name="acao" value="recusar_orcamento" class="btn btn-danger">
                            <i class="fas fa-times me-2"></i>Recusar (Orçamento)
                        </button>
                    {% endif %}
                {% endif %}
                
                {% if etp.status == 'APROVADO' and not tr_vinculado %}
                    <a href="{% url 'contratacoes:gerar_tr_a_partir_etp' pk=etp.pk %}" class="btn btn-success">
                        <i class="fas fa-file-signature me-2"></i>Gerar Termo de Referência
                    </a>
                {% elif tr_vinculado %}
                     <a href="{% url 'contratacoes:detalhar_tr' pk=tr_vinculado.pk %}" class="btn btn-info">
                        <i class="fas fa-eye me-2"></i>Ver TR Vinculado
                    </a>
                {% endif %}
            </form>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">Análise Preliminar Automatizada</h5>
        </div>
        <div class="card-body">
            {% if pendencias_analise %}
                <div class="alert alert-warning mb-0">
                    <p class="fw-bold">Atenção: Foram identificadas as seguintes pendências:</p>
                    <ul class="mb-0">
                        {% for pendencia in pendencias_analise %}
                            <li>{{ pendencia }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <div class="alert alert-success mb-0">
                    <p class="mb-0">✔️ Nenhuma pendência encontrada na análise preliminar.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5 class="mb-0">Informações do ETP</h5></div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Título</dt><dd class="col-sm-9">{{ etp.titulo }}</dd>
                <dt class="col-sm-3">Nº do Processo</dt><dd class="col-sm-9">{{ etp.numero_processo }}</dd>
                <dt class="col-sm-3">Setor Demandante</dt><dd class="col-sm-9">{{ etp.setor_demandante }}</dd>
                <dt class="col-sm-3">Valor Estimado</dt><dd class="col-sm-9">R$ {{ etp.estimativa_valor|floatformat:2 }}</dd>
                <hr class="my-3">
                <dt class="col-sm-3">Descrição da Necessidade</dt><dd class="col-sm-9">{{ etp.descricao_necessidade|linebreaksbr }}</dd>
                </dl>
        </div>
    </div>
    
    {% if etp.item_pca_vinculado %}
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5 class="mb-0">Item do PCA Vinculado</h5></div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">PCA</dt><dd class="col-sm-9">{{ etp.item_pca_vinculado.pca.ano_vigencia }}</dd>
                <dt class="col-sm-3">Identificador</dt><dd class="col-sm-9">{{ etp.item_pca_vinculado.identificador_item }}</dd>
                <dt class="col-sm-3">Descrição PCA</dt><dd class="col-sm-9">{{ etp.item_pca_vinculado.descricao_item }}</dd>
                <dt class="col-sm-3">Valor Estimado PCA</dt><dd class="col-sm-9">R$ {{ etp.item_pca_vinculado.valor_estimado_pca|floatformat:2 }}</dd>
                <dt class="col-sm-3">Unidade PCA</dt><dd class="col-sm-9">{{ etp.item_pca_vinculado.unidade_requisitante }}</dd>
            </dl>
        </div>
    </div>
    {% endif %}

    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5 class="mb-0">Pesquisas de Preço</h5></div>
        <div class="card-body">
            {% if etp.pesquisas_preco.all %}
                <table class="table table-striped table-hover mb-0">
                    <thead><tr><th>Fornecedor</th><th>Valor (R$)</th><th>Data</th></tr></thead>
                    <tbody>
                    {% for pesquisa in etp.pesquisas_preco.all %}
                        <tr>
                            <td>{{ pesquisa.fornecedor }}</td>
                            <td>{{ pesquisa.valor_cotado|floatformat:2 }}</td>
                            <td>{{ pesquisa.data_pesquisa|date:"d/m/Y" }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted mb-0">Nenhuma pesquisa de preço adicionada.</p>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Anexos</h5>
            <a href="{% url 'contratacoes:adicionar_anexo_etp' etp_id=etp.pk %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-plus me-2"></i>Adicionar Anexo
            </a>
        </div>
        <div class="card-body p-0">
            {% if etp.anexos.all %}
                <ul class="list-group list-group-flush">
                {% for anexo in etp.anexos.all %}
                    <li class="list-group-item">
                        <a href="{{ anexo.arquivo.url }}" target="_blank">{{ anexo.titulo }}</a>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <div class="p-3"><p class="text-muted mb-0">Nenhum anexo para este ETP.</p></div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock content %}